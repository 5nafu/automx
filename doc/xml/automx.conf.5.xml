<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE refentry PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<refentry>
  <refentryinfo>
    <title>automx.conf</title>

    <authorgroup>
      <author>
        <firstname>Christian</firstname>

        <surname>Roessner</surname>

        <contrib>Wrote the program.</contrib>

        <email>c@roessner-network-solutions.com</email>
      </author>

      <editor>
        <firstname>Patrick</firstname>

        <othername>Ben</othername>

        <surname>Koetter</surname>

        <contrib>Wrote the documentation.</contrib>

        <email>p@state-of-mind.de</email>
      </editor>
    </authorgroup>
  </refentryinfo>

  <refmeta>
    <refentrytitle>automx.conf</refentrytitle>

    <manvolnum>5</manvolnum>

    <refmiscinfo>Version 0.8_beta1</refmiscinfo>

    <refmiscinfo>automx Manual</refmiscinfo>
  </refmeta>

  <refnamediv>
    <refname><filename>automx.conf</filename></refname>

    <refpurpose>automx configuration parameters</refpurpose>
  </refnamediv>

  <refsection>
    <title>Description</title>

    <para>The <systemitem class="service">automx</systemitem>
    <filename>automx.conf</filename> configuration file specifies all
    parameters that control the <systemitem
    class="service">automx</systemitem> configuration system. Parameters not
    specified in <filename>automx.conf</filename> are left at their default
    values.</para>
  </refsection>

  <refsection>
    <title>Syntax</title>

    <para>The general format of the <filename>automx.conf</filename> file is
    as follows:</para>

    <itemizedlist>
      <listitem>
        <para>Each logical line has the form <quote>parameter = value</quote>.
        Whitespace around the <quote>=</quote> is ignored, as is whitespace at
        the end of a logical line.</para>
      </listitem>

      <listitem>
        <para>Empty lines and whitespace-only lines are ignored, as are lines
        whose first non-whitespace character is a <quote>#</quote>.</para>
      </listitem>

      <listitem>
        <para>When the same parameter is defined multiple times, only the last
        instance is remembered.</para>
      </listitem>

      <listitem>
        <para>Uppercase and lowercase matters. Use parameter names, macros and
        variables exactly as specified.</para>
      </listitem>
    </itemizedlist>
  </refsection>

  <refsection>
    <title>Structure</title>

    <para>The configuration file is split into sections.</para>

    <itemizedlist>
      <listitem>
        <para>A section begins with the section name surrounded by square
        brackets, e.g. [example.com].</para>
      </listitem>

      <listitem>
        <para>A section name identifies a domain or subdomain automx should
        respond with autoconfiguration instructions upon client
        request.</para>
      </listitem>

      <listitem>
        <para>A section defines services which will be sent as
        autoconfiguration instructions to a client.</para>
      </listitem>

      <listitem>
        <para>Section names <option>automx</option>, <option>default</option>
        and <option>GLOBAL</option> are reserved - they have special
        meaning.</para>
      </listitem>
    </itemizedlist>
  </refsection>

  <refsection id="services">
    <title>Services</title>

    <para>Each section may specify one more services that should be provided
    to the client. A service must be defined in a section in order to be
    enabled. Options specific to a service are given using a concatenation of
    a service name and the parameter it should configure.</para>

    <example>
      <title>Defining a service option</title>

      <para>The following concatenation of service name <option>smtp</option>
      and service option <parameter>_server</parameter> creates the
      <parameter>smtp_server</parameter> parameter:</para>

      <programlisting>smtp_server = mail.example.com</programlisting>
    </example>

    <para>Service names available in automx are shown in the following list.
    The service options to create parameters are specified in <xref
    linkend="parameters" />:</para>

    <variablelist>
      <varlistentry>
        <term><option>imap</option></term>

        <listitem>
          <para>This name specifies a service as defined in <ulink
          url="http://www.rfc-editor.org/rfc/rfc3501.txt">RFC 3501</ulink>.
          The protocol to connect to this server is IMAP. Specifying this name
          is only applicable for <parameter>account_type</parameter> =
          <option>email</option>.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><option>pop</option></term>

        <listitem>
          <para>This name specifies a service as defined in <ulink
          url="http://www.rfc-editor.org/rfc/rfc1939.txt">RFC 1939</ulink>.
          The protocol to connect to this server is POP3. Specifying this name
          is only applicable for <parameter>account_type</parameter> =
          <option>email</option>.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><option>smtp</option></term>

        <listitem>
          <para>This name specifies an SMTP service as defined in <ulink
          url="http://www.rfc-editor.org/rfc/rfc5321.txt">RFC 5321</ulink>.
          The protocol to connect to this server is SMTP. Specifying this name
          is only applicable for <parameter>account_type</parameter> =
          <option>email</option>.</para>
        </listitem>
      </varlistentry>
    </variablelist>
  </refsection>

  <refsection>
    <title id="parameters">Parameters</title>

    <variablelist>
      <varlistentry>
        <term>autoconfig (no default)</term>

        <listitem>
          <para>Specifies a path to a file that contains static
          autoconfiguration options following to the Mozilla schema.</para>

          <note>
            <para>This parameter is valid only if backend = file has been
            specified.</para>
          </note>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term>autodiscover (no default)</term>

        <listitem>
          <para>Specifies a path to a file that contains static
          autoconfiguration options following to the Microsoft schema.</para>

          <note>
            <para>This parameter is valid only if backend = file has been
            specified.</para>
          </note>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter>account_name</parameter> (no default,
        mandatory)</term>

        <listitem>
          <para>Specifies a display name in MUA account listings.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter>account_name_short</parameter> (no default,
        mandatory)</term>

        <listitem>
          <para>Specifies a short display name in MUA account listings.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter>account_type</parameter> (default:
        <option>email</option>, mandatory)</term>

        <listitem>
          <para>Specifies the account type that should be configured:</para>

          <variablelist>
            <varlistentry>
              <term><option>email</option></term>

              <listitem>
                <para>Setting this option will create an email
                configuration.</para>
              </listitem>
            </varlistentry>
          </variablelist>

          <note>
            <para>The Microsoft schema specifies additional account_types.
            Currently automx only supports <option>email</option>.</para>
          </note>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter>action</parameter> (default:
        <option>settings</option>, mandatory)</term>

        <listitem>
          <para>Specifies whether the response to the client contains
          configuration settings or if it should visit a different server or
          use a different address.</para>

          <note>
            <para>This option applies to Microsoft schema only.</para>
          </note>

          <variablelist>
            <varlistentry>
              <term>settings</term>

              <listitem>
                <para>The client should use the configuration settings sent in
                this response.</para>
              </listitem>
            </varlistentry>
          </variablelist>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter>backend</parameter> (default:
        <option>DEFAULT</option>, mandatory)</term>

        <listitem>
          <para>Specifies the backend method to lookup configuration data. The
          following options are available:</para>

          <variablelist>
            <varlistentry>
              <term><option>file</option></term>

              <listitem>
                <para><systemitem>automx</systemitem> should use logic
                provided within this section to identify a different section
                which holds configuration settings.</para>

                <programlisting>backend = file</programlisting>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><option>filter</option></term>

              <listitem>
                <para><systemitem>automx</systemitem> should use logic
                provided within this section to identify a different section
                which holds configuration settings.</para>

                <programlisting>backend = filter</programlisting>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><option>global</option></term>

              <listitem>
                <para><systemitem>automx</systemitem> should use general
                settings defined in the <option>global</option>
                section.</para>

                <programlisting>backend = global</programlisting>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><option>ldap</option></term>

              <listitem>
                <para><systemitem>automx</systemitem> should use a mixture of
                general and individual settings. General settings are set like
                static settings. Individual settings should be retrieved from
                an LDAP query.</para>

                <programlisting>backend = ldap</programlisting>

                <note>
                  <para>See also <citerefentry>
                      <refentrytitle>automx_ldap</refentrytitle>

                      <manvolnum>5</manvolnum>
                    </citerefentry> for a list of LDAP related configuration
                  options.</para>
                </note>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><option>sql</option></term>

              <listitem>
                <para><systemitem>automx</systemitem> should use a mixture of
                general and individual settings. General settings are set like
                static settings. Individual settings should be retrieved from
                an SQL query.</para>

                <programlisting>backend = sql</programlisting>

                <note>
                  <para>See also <citerefentry>
                      <refentrytitle>automx_sql</refentrytitle>

                      <manvolnum>5</manvolnum>
                    </citerefentry> for a list of SQL related configuration
                  options.</para>
                </note>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><option>static</option></term>

              <listitem>
                <para><systemitem>automx</systemitem> should use general
                settings provided within the current section.</para>

                <programlisting>backend = static</programlisting>
              </listitem>
            </varlistentry>
          </variablelist>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter>debug</parameter> (default: no)</term>

        <listitem>
          <para>Specifies if automx should note client request and server
          response to the (SSL) error log.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter>display_name</parameter> (no default,
        optional)</term>

        <listitem>
          <para>Specifies an <quote>optional display name that indicates the
          name of the sender (...) that could be displayed to the user of a
          mail application</quote> (see: 3.4. Address Specification in <ulink
          url="http://tools.ietf.org/rfc/rfc5322.txt">RFC 5322</ulink>). The
          client can decide to accept or change the name.</para>

          <note>
            <para>This option applies to Microsoft schema only.</para>
          </note>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter>domains</parameter> (no default)</term>

        <listitem>
          <para>Specifies a list of domains automx will output
          autoconfiguration information for.</para>

          <variablelist>
            <varlistentry>
              <term><option>*</option></term>

              <listitem>
                <para>Specify <option>*</option> to let automx reply for any
                domains listed in a section.</para>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><option>domain, domain, ...</option></term>

              <listitem>
                <para>Specify a comma separated list of domains automx should
                provide autoconfiguration for.</para>
              </listitem>
            </varlistentry>
          </variablelist>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter>provider</parameter> (no default, mandatory)</term>

        <listitem>
          <para>The FQDN domain name of the domain that provides the
          configuration service.</para>

          <programlisting>provider = example.com</programlisting>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter>section_filter</parameter> (default:
        <option>domainpart</option>, optional)</term>

        <listitem>
          <para>Specifies a list of one or more filters whose result outputs a
          section name. The filters will be used in order specified. The first
          match ends execution of subsequent filters.</para>

          <para>These filters will be used instead of the hard coded, internal
          <option>domainpart</option> filter, which strictly uses the
          domainpart taken from the email address the client submitted in its
          configuration request.</para>

          <programlisting>section_filters = server_1, server_2
server_1 = /usr/sbin/postmap -q "%u" hash:/etc/postfix/virtual_alias_domains | \
    sed -e 's/^.*@\(\.*\)/\1/g' | grep internal.example.com
server_2 = /usr/sbin/postmap -q "%u" hash:/etc/postfix/virtual_alias_domains | \
    sed -e 's/^.*@\(\.*\)/\1/g' | grep dmz.example.com</programlisting>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter><replaceable>service</replaceable></parameter>
        (default: <option>no</option>)</term>

        <listitem>
          <para>Specifies the service type that should be provided in the
          configuration response. By default all services are disabled. See
          <xref linkend="services" /> for a list of valid service
          names.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter><replaceable>service</replaceable>_auth_identity</parameter>
        (no default)</term>

        <listitem>
          <para>Specifies the login name the client should use when it
          identifies the user in order to gain access to the service. See
          <xref linkend="macros" /> for available options.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter><replaceable>service</replaceable>_auth</parameter>
        (no default)</term>

        <listitem>
          <para>Specifies the method the client should use when it identifies
          the user in order to gain access to the service. The following
          options are available:</para>

          <note>
            <para>Thunderbird 3.0 accepts only <quote>plain</quote> and
            <quote>secure</quote>. It will ignore the whole XML file, if other
            values are given.</para>
          </note>

          <variablelist>
            <varlistentry>
              <term><option>plaintext</option></term>

              <listitem>
                <para>The client should use the SASL mechanisms
                <option>PLAIN</option> or <option>LOGIN</option> to identify
                the user.</para>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><option>encrypted</option></term>

              <listitem>
                <para>The client should use the SASL mechanisms
                <option>CRAM-MD5</option> or <option>DIGEST-MD5</option> to
                identify the user.</para>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><option>ntlm</option></term>

              <listitem>
                <para>The client should use the SASL <option>NTLM</option>
                mechanism to identify the user.</para>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><option>gssapi</option></term>

              <listitem>
                <para>The client should use the SASL <option>GSSAPI</option>
                mechanism to identify the user.</para>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><option>client-ip-address</option></term>

              <listitem>
                <para>The client will not send identification data. Instead
                the server should recognize the user based on the clients IP
                address.</para>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><option>tls-client-cert</option></term>

              <listitem>
                <para>The client should send a TLS client certificate when the
                server requests one.</para>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term>smtp-after-pop</term>

              <listitem>
                <para>The client should authenticate using POP first, and then
                start sending messages over SMTP later.</para>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><option>none</option></term>

              <listitem>
                <para>The client should not send any identification
                data.</para>
              </listitem>
            </varlistentry>
          </variablelist>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter><replaceable>service</replaceable>_port</parameter>
        (no default)</term>

        <listitem>
          <para>Specifies port number on which the service is offered.
          Typical, standardized port numbers are:</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter><replaceable>service</replaceable>_server</parameter>
        (no default)</term>

        <listitem>
          <para>Specifies the IP address or hostname on which the service is
          offered.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter><replaceable>service</replaceable>_encryption</parameter>
        (no default)</term>

        <listitem>
          <para>Specifies whether the client should use a plaintext or an
          encrypted transport layer for client-server communication. The
          following options are available:</para>

          <variablelist>
            <varlistentry>
              <term><option>auto</option></term>

              <listitem>
                <para>The client should try to start with
                <option>starttls</option>, proceed with <option>ssl</option>
                and settle with <option>none</option>, if only that is
                available.</para>

                <note>
                  <para>This feature is not available in clients following the
                  Mozilla schema. For these clients automx will always output
                  <option>none</option> as encryption level.</para>
                </note>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><option>none</option></term>

              <listitem>
                <para>The client should use an unencrypted transport
                layer.</para>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><option>ssl</option></term>

              <listitem>
                <para>The client should use an SSL3 or TLS1 encrypted
                transport layer from the start.</para>

                <note>
                  <para>This option is typical for <option>smtps</option>,
                  <option>pop3s</option> and <option>imaps</option> services
                  and usually requires a dedicated port on the server for SSL
                  encryption only.</para>
                </note>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term><option>starttls</option></term>

              <listitem>
                <para>The client should begin communication on an unencrypted
                port and then upgrade the communication to TLS via the
                STARTTLS command.</para>

                <note>
                  <para>This option is typical for <option>smtp</option>,
                  <option>pop3</option> and <option>imap</option>
                  services.</para>
                </note>
              </listitem>
            </varlistentry>
          </variablelist>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter>smtp_author</parameter> (default:
        <option>%s</option>)</term>

        <listitem>
          <para>Specifies the envelope sender address used when the client
          sends a message. See <xref linkend="macros" /> for available
          options.</para>

          <note>
            <para>This parameter is experimental. The feature is available for
            Microsoft clients only. For a definition of <quote>author</quote>
            see also <ulink
            url="http://tools.ietf.org/html/rfc5598#section-2.1">RFC 5598,
            Section 2.1 User Actors</ulink>.</para>
          </note>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter>smtp_default</parameter> (no default)</term>

        <listitem>
          <para>Specifies if this service should be used globally for all
          outgoing messages from all accounts.</para>

          <note>
            <para>This feature is available to clients following the Mozilla
            schema only.</para>
          </note>
        </listitem>
      </varlistentry>
    </variablelist>
  </refsection>

  <refsection id="macros">
    <title>Macros and Variables</title>

    <para>The following macros and variables can be used within
    <systemitem>automx</systemitem> to build service configuration.</para>

    <variablelist>
      <varlistentry>
        <term><option>%%</option></term>

        <listitem>
          <para>This is replaced by a literal <quote>%</quote>
          character.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><option>%d</option></term>

        <listitem>
          <para>When the input key is an address of the form
          <literal>localpart@domainpart</literal>, this macro will be replaced
          by the (<ulink url="http://www.ietf.org/rfc/rfc2253.txt">RFC
          2253</ulink>) quoted domain part of the address.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><option>%s</option></term>

        <listitem>
          <para>This macro is replaced by the input key.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><option>${varname}</option></term>

        <listitem>
          <para>The value of <varname>${varname}</varname>, retrieved from an
          LDAP or SQL query, will be used.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><option>%u</option></term>

        <listitem>
          <para>When the input key is an address of the form
          <literal>localpart@domainpart</literal>, this macro will be replaced
          by the (<ulink url="http://www.ietf.org/rfc/rfc2253.txt">RFC
          2253</ulink>) quoted local part of the address.</para>
        </listitem>
      </varlistentry>
    </variablelist>
  </refsection>

  <refsection>
    <title>See also</title>

    <para><citerefentry>
        <refentrytitle>automx</refentrytitle>

        <manvolnum>8</manvolnum>
      </citerefentry>, <citerefentry>
        <refentrytitle>automx.conf</refentrytitle>

        <manvolnum>5</manvolnum>
      </citerefentry>, <citerefentry>
        <refentrytitle>automx_ldap</refentrytitle>

        <manvolnum>5</manvolnum>
      </citerefentry>, <citerefentry>
        <refentrytitle>automx_sql</refentrytitle>

        <manvolnum>5</manvolnum>
      </citerefentry>, <citerefentry>
        <refentrytitle>automx-test</refentrytitle>

        <manvolnum>1</manvolnum>
      </citerefentry></para>
  </refsection>
</refentry>
